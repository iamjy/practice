/**
 * @file
 * @author
 * @date
 * @brief
 * @see
 */

/*****************************************************************************
 * Headers
 *****************************************************************************/
#include "thread.h"

/*****************************************************************************
 * Macro definitions
 *****************************************************************************/

/*****************************************************************************
 * Enumerations
 *****************************************************************************/

/*****************************************************************************
 * Structures
 *****************************************************************************/

/*****************************************************************************
 * Global variables
 *****************************************************************************/
static pthread_cond_t s_cond = PTHREAD_COND_INITIALIZER;
static pthread_cond_t d_cond;
static pthread_mutex_t s_lock = PTHREAD_MUTEX_INITIALIZER;
static pthread_mutex_t d_lock;

static int g_cnt = 0;
static volatile int vg_cnt = 0;

/*****************************************************************************
 * Static variables
 *****************************************************************************/

/*****************************************************************************
 * Extern variables
 *****************************************************************************/

/*****************************************************************************
 * Function prototypes
 *****************************************************************************/

/*****************************************************************************
 * Function definitions
 *****************************************************************************/
void *detached_thread(void *data)
{
	int i = 0;
	pthread_t pid = pthread_self();

	for (i = 0; i < 100000; i++) {
		pthread_mutex_lock(&d_lock);
		printf("[%d]vg_cnt %d\n", pid, vg_cnt++);
		sleep(1);
		pthread_mutex_unlock(&d_lock);
	}

	pthread_exit((void *)0);
}

void *sig_send_thread(void *data)
{
	bool once = *(bool *)data;

	do {

		pthread_cond_signal(&s_cond);

	} while (once != true && g_cnt < 10);

	printf("s!\n");

	pthread_exit((void *)g_cnt);
}

void *sig_receive_thread(void *data)
{
	g_cnt = *(int *)data;

	do {

		pthread_cond_wait(&s_cond, &s_lock);
		printf("%d\n", g_cnt++);

	} while (g_cnt < 10);

	printf("r!\n");

	pthread_exit((void *)g_cnt);
}
